#!/bin/bash

set -e -f -u -o pipefail

if [[ "$#" -eq 0 ]]; then
  printf "USAGE: %s URL [URLS]\\n" "$0" >&2
  exit 1
fi

# Only update homebrew if it's been at least 4 hours since the last update.
old_dir="$(find /usr/local/Homebrew/ -maxdepth 1 -name .git -cmin +240)"
if [[ -n "${old_dir}" ]]; then
  printf "Updating homebrew\\n"
  brew update
fi
printf "Checking for new binaries: "
for binary in youtube-dl ffmpeg $(brew deps ffmpeg); do
  printf " %s" "${binary}"
  if ! brew list | grep -q "^${binary}$"; then
    printf "\\nInstalling %s\\n" "${binary}"
    brew install "${binary}"
  fi
  if brew outdated | grep -q "^${binary}$"; then
    printf "\\nUpdating %s\\n" "${binary}"
    brew upgrade "${binary}"
  fi
done
printf "\\nFinished checking for new binaries\\n"

until /usr/local/bin/youtube-dl "$@"; do
  sleep 10
done
