#!/bin/bash

set -e -f -u -o pipefail

check_single_host() {
  local host="$1"
  printf "\n\n\nProcessing %s\\n" "${host}"
  # shellcheck disable=SC2016
  retry 10 "${host}" ssh -o ControlMaster=no -t "johntobin@${host}" \
    'check-git-repos --pull "${HOME}/bin" "${HOME}/src/"*'
}

# Clean up most likely source of diffs first.
update-dotfiles-and-bin-everywhere
check_single_host laptop
check_single_host home
# Ariane's website needs special treatment, so do that before the more general
# check of hosting.
retry 10 hosting ssh -o ControlMaster=no -t johntobin@hosting \
  update-ariane-theme
check_single_host hosting
