#!/bin/bash

set -e -f -u -o pipefail

commit_all() {
  local dir="$1"
  local subdir="wp-content/themes/ariane-theme"

  # Check for local changes.
  cd "${dir}/${subdir}"
  local git_status
  git_status="$(git status --short)"
  if [[ -n "${git_status}" ]]; then
    die "Uncommitted changes in ${PWD}:\\n" "${git_status}"
  fi
  # Sync with upstream.
  git pull
  git push
  # Update parent repo so that backups and updates work.
  cd "${dir}"
  git diff-index --quiet HEAD || git upstream
  if [[ -n "$(git status --short)" ]]; then
    git add "wp-content/themes/ariane-theme"
    git upstream
  fi
}

main() {
  if [[ "$#" -eq 0 ]]; then
    # Updat dev.
    commit_all "${HOME}/dev.arianetobin.ie"
    # Update www.
    ssh -o ControlPath=none arianetobin@hosting \
      "${HOME}/bin/update-ariane-theme" www
    # Clear mod_pagespeed cache to ensure consistency, e.g. correct style.css
    # being used.
    sudo touch /var/cache/mod_pagespeed/cache.flush
  else
    # This is being run over ssh as arianetobin.
    commit_all "${HOME}/arianetobin.ie/"
  fi
}

main "$@"
