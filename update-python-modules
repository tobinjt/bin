#!/bin/bash

set -e -f -u -o pipefail

usage() {
  printf "Usage: %s [--skip_clean_install]\\n" "$0"
}

virtualenv_install() {
  local destdir="$1"
  shift

  brew install virtualenv
  mkdir -p "${destdir}"
  # Run virtualenv from the destination directory just in case.
  cd "${destdir}"
  virtualenv --clear "${destdir}"
  # virtualenv sometimes deletes the destination directory so cd there again.
  cd "${destdir}"
  source bin/activate

  # Install packages one by one so that it's easier to figure out which package
  # is broken when something goes wrong.
  local package
  for package in "$@"; do
    printf "\n\npip3 install %s\\n" "${package}"
    pip3 install "${package}"
  done
  deactivate
}

main() {
  if ! is_mac_os; then
    printf "Only Mac OS is supported, sorry.\\n" >&2
    exit 1
  fi
  while :; do
    case "${1:-}" in
      ?*)
        usage >&2
        return 1
        ;;
      '')
        # Empty string when $1 doesn't expand to anything, argument processing
        # finished successfully.
        break
        ;;
    esac
  done

  # Dummy values needed by activate scripts.
  export PS1="dummy"
  # Let Python write bytecode.
  unset PYTHONDONTWRITEBYTECODE
  # Install Python, just in case.
  brew install python

  # Clean up existing install.
  local virtualenv_dir="${HOME}/tmp/virtualenv"
  rm -rf "${virtualenv_dir}"

  # Flexget.  Only install and test on machines where I normally run flexget.
  if [[ -d "${HOME}/tmp/logs/flexget" ]]; then
    virtualenv_install "${virtualenv_dir}/flexget" "flexget" "transmission-rpc"
    printf "\\n\\nTesting Flexget\\n"
    flexget-wrapper execute
    printf "\\n\\n\\n\\n\\n"
  fi

  # I tried using homebrew packages for some tools, but that lead to a terrible
  # mix of Python versions and tools not finding modules so I reverted to using
  # Pip for everything.

  # Install all Python development tools in a single virtualenv so all the
  # modules are easily available at the same time.
  # Removed packages: mutmut depends on pony which doesn't support Python 3.9.
  # mypy needs lxml but doesn't depend on it.
  virtualenv_install "${virtualenv_dir}/python" lxml mypy pudb pyfakefs pylint \
    pytest pytest-cov pytest-flakefinder pyyaml yapf
  # Normally $PATH will contain this directory; add it so that initial
  # installation works when $PATH does not contain it.
  PATH="${PATH}:${virtualenv_dir}/python/bin"
  hash -r

  # Check that tools work properly.
  cd "${HOME}/bin/python"
  pytest
  set +f
  pylint -- *.py
  mypy -- *.py
  set -f
}

main "$@"
