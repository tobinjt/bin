#!/bin/bash

set -e -f -u -o pipefail

# Restart with updated code if necessary.
orig_code="$(cat "${BASH_SOURCE[0]}")"
retry update-dotfiles-and-bin -- update-dotfiles-and-bin
new_code="$(cat "${BASH_SOURCE[0]}")"
if [[ "${orig_code}" != "${new_code}" ]]; then
  echo "Restarting with updated tools"
  exec "${BASH_SOURCE[0]}"
fi

if is_mac_os && type brew >& /dev/null; then
  retry brew-update-brew-cleanup -- brew-update-brew-cleanup
fi
retry update-dotfiles-and-bin-plugins -- update-dotfiles-and-bin-plugins
retry update-all-pre-commit-hooks -- update-all-pre-commit-hooks
retry install-extra-development-tools -- install-extra-development-tools

if [[ -f "/Applications/AdGuardHome/AdGuardHome" ]]; then
  retry AdGuard -- update-adguard
fi
if [[ -d "${HOME}/tmp/bin/lazygit" ]]; then
  retry update-lazygit -- update-lazygit
fi
if [[ -d "${HOME}/tmp/bin/nvim" ]]; then
  retry update-nvim -- update-nvim
fi
if [[ -d "${HOME}/tmp/bin/virtualenv" ]]; then
  retry update-python-modules -- update-python-modules
fi
if [[ -d "${HOME}/wordpress" ]]; then
  retry update-all-wordpress -- update-all-wordpress
fi
