#!/bin/bash

set -e -f -u -o pipefail

main() {
  # Figure out the latest release
  local latest_url="https://github.com/jesseduffield/lazygit/releases/latest"
  local redirect_url
  redirect_url="$(curl -Ls -o /dev/null -w '%{url_effective}\n' "${latest_url}")"
  local version
  version="$(basename "${redirect_url}")"
  version="${version/v/}"
  readonly version
  if is_mac_os; then
    if is_x86_64; then
      os_type="Darwin_x86_64"
    else
      os_type="Darwin_arm64"
    fi
  else
    os_type="Linux_x86_64"
  fi
  local url="https://github.com/jesseduffield/lazygit/releases/download/"
  url+="v${version}/lazygit_${version}_${os_type}.tar.gz"
  readonly url
  local filename
  filename="$(basename "${url}")"
  readonly filename
  local extraction_dir
  extraction_dir="${HOME}/tmp/bin/lazygit/lazygit.$(date +%Y-%m-%d)"
  readonly extraction_dir

  mkdir -p "${extraction_dir}"
  cd "${extraction_dir}"
  rm -f "${filename}"
  curl --location --output "${filename}" "${url}"
  tar zxvf "$(basename "${url}")"
  ./lazygit --help
  cd ..
  ln -s -f -n "${extraction_dir}/lazygit" lazygit
}

main "$@"
