#!/bin/bash

set -e -f -u -o pipefail

# Only update if we haven't updated recently.
file="/usr/local/Homebrew/Library/Taps/homebrew/homebrew-core/.git/FETCH_HEAD"
if [[ -n "$(find "${file}" -mtime +3h)" ]]; then
  brew update
  sleep 2
fi
brew outdated
# Removing old versions of vim breaks running vim sessions, and sometimes the
# autocmds break badly enough that modified files can't be saved.  Hopefully
# this will disable removal of old versions of vim.
export HOMEBREW_NO_CLEANUP_FORMULAE=vim
# Separately upgrade formula and casks so I can force bottles.
# Sometimes a formula doesn't have a bottle and upgrading will fail, so we
# survive the failure and try again without forcing bottle.
brew upgrade --force-bottle --formula || true
sleep 2
brew upgrade --formula
sleep 2
brew upgrade --cask --greedy
sleep 2
brew cleanup
